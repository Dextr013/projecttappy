(()=>{async function G(){if(window.YaGames||await new Promise(t=>setTimeout(t,300)),!window.YaGames)throw new Error("YaGames not loaded");return await window.YaGames.init()}function R(h){let t=h.environment||{};return{appId:t.app&&t.app.id||"unknown",lang:t.i18n&&t.i18n.lang||"ru",tld:t.i18n&&t.i18n.tld||"ru",payload:t.payload||null}}async function T(h,t,e){try{let s=await h.getFlags({defaultFlags:t,clientFeatures:e});return{...t,...s||{}}}catch(s){return console.warn("getFlags failed, using defaults",s),t}}async function L(h){try{return await h.getPlayer({signed:!1})}catch{try{await h.auth.openAuthDialog()}catch{}return null}}var F=Math.PI*2,I=class{constructor({canvas:t,assets:e,audio:s,flags:a,onScore:n,onDeath:o,onStart:l,onPause:u,onResume:f,onDistance:m,onOvertake:k,selectedSkin:b="blue",skins:v}){this.canvas=t,this.ctx=t.getContext("2d"),this.assets=e,this.audio=s,this.flags=a,this.onScore=n,this.onDeath=o,this.onStart=l,this.onPause=u,this.onResume=f,this.onDistance=m,this.onOvertake=k,this.metersPerPixel=this.flags.metersPerPixel||.2,this.distanceMeters=0,this.skins=v||{},this.currentSkin=b,this.ghosts=[],this.state="menu",this.score=0,this.best=0,this.world={width:t.width,height:t.height},this.rocks=[],this.lastPipeMs=0,this.accumulator=0,this.images={},this.planeFrames=[],this.frameIndex=0,this.frameTimer=0,this.plane={x:120,y:t.height/2,vy:0,r:28},this._bindInput(),this._loadAssets().then(()=>this._resizeToFit()),window.addEventListener("resize",()=>this._resizeToFit()),this._loop=this._loop.bind(this),requestAnimationFrame(this._loop)}async _loadAssets(){let t=e=>new Promise((s,a)=>{let n=new Image;n.src=e,n.onload=()=>s(n),n.onerror=a});this.images.bg=await t(this.assets.bg),this.images.rock=await t(this.assets.rock),this.images.rockDown=await t(this.assets.rockDown);for(let e of this.assets.planeFrames)this.planeFrames.push(await t(e));if(this.skins){for(let e of Object.keys(this.skins)){let s=[];for(let a of this.skins[e])s.push(await t(a));this.skins[e]=s}this._applySkin(this.currentSkin)}}_bindInput(){let t=e=>{this.state!=="menu"&&this.state!=="dead"&&this.state!=="paused"&&(this.plane.vy=-this.flags.flapImpulse,this.audio.flap(),e?.preventDefault?.())};this.canvas.addEventListener("pointerdown",t,{passive:!1}),window.addEventListener("keydown",e=>{e.code==="Space"&&t(e),e.code==="KeyP"&&this.pause()})}_resizeToFit(){let{innerWidth:t,innerHeight:e}=window,s=this.canvas.width/this.canvas.height,a=t,n=t/s;n>e&&(n=e,a=e*s),this.canvas.style.width=`${a}px`,this.canvas.style.height=`${n}px`}isRunning(){return this.state==="running"}setSkin(t){!this.skins||!this.skins[t]||(this.currentSkin=t,this._applySkin(t))}_applySkin(t){this.skins&&this.skins[t]&&(this.planeFrames=this.skins[t],this.frameIndex=0)}setOpponents(t){this.ghosts=Array.isArray(t)?t.map(e=>({...e,overtaken:!1})):[]}async start(){this.state!=="menu"&&this.state!=="paused"||(this._reset(),this.state="running",this.onStart?.())}pause(){this.state==="running"&&(this.state="paused",this.onPause?.())}resume(){this.state==="paused"&&(this.state="running",this.onResume?.())}async restart(){this._reset(),this.distanceMeters=0,this.state="running",this.onResume?.()}async continueAfterDeath(){this.state==="dead"&&(this.state="running",this.plane.vy=-this.flags.flapImpulse*.8,this.onResume?.())}_reset(){this.score=0,this.distanceMeters=0,this.rocks=[],this.plane={x:120,y:this.canvas.height/2,vy:0,r:28},this.lastPipeMs=0}_spawnRocks(){let t=this.flags.pipeGap,e=120,s=this.world.height-220,a=Math.random()*(s-e)+e,n=Math.max(40,a-t/2),o=a+t/2,l=this.world.height-o-40,u=this.world.width+40;this.rocks.push({x:u,y:0,w:64,h:n,passed:!1,type:"top"}),this.rocks.push({x:u,y:o,w:64,h:l,passed:!1,type:"bottom"})}_update(t){if(this.state!=="running")return;this.plane.vy+=this.flags.gravity*t,this.plane.y+=this.plane.vy*t,this.distanceMeters+=this.flags.scrollSpeed*t*this.metersPerPixel,this.onDistance?.(this.distanceMeters),this.lastPipeMs+=t*1e3,this.lastPipeMs>=this.flags.pipeIntervalMs&&(this.lastPipeMs=0,this._spawnRocks());let e=this.flags.scrollSpeed;for(let n of this.rocks)n.x-=e*t;this.rocks=this.rocks.filter(n=>n.x+n.w>-80);for(let n=0;n<this.rocks.length;n+=2){let o=this.rocks[n].x+this.rocks[n].w;!this.rocks[n].passed&&o<this.plane.x-this.plane.r&&(this.rocks[n].passed=this.rocks[n+1].passed=!0,this.score+=1,this.audio.score(),this.onScore?.(this.score))}let s=this.plane.y+this.plane.r>this.world.height-20,a=this.plane.y-this.plane.r<0;(s||a||this._collides())&&(this.audio.hit(),this.state="dead",this.onDeath?.(this.score,this.distanceMeters))}_collides(){let t=this.plane.x,e=this.plane.y,s=this.plane.r;for(let a of this.rocks){let n=Math.max(a.x,Math.min(t,a.x+a.w)),o=Math.max(a.y,Math.min(e,a.y+a.h)),l=t-n,u=e-o;if(l*l+u*u<s*s)return!0}return!1}_draw(){let{ctx:t,world:e}=this;t.clearRect(0,0,e.width,e.height),this.images.bg&&t.drawImage(this.images.bg,0,0,e.width,e.height);for(let n of this.rocks){let o=n.type==="top"?this.images.rockDown:this.images.rock;o?t.drawImage(o,n.x,n.y,n.w,n.h):(t.fillStyle="#6f8",t.fillRect(n.x,n.y,n.w,n.h))}this.frameTimer+=1,this.frameTimer%8===0&&(this.frameIndex=(this.frameIndex+1)%this.planeFrames.length);let s=this.planeFrames[this.frameIndex],a=Math.atan2(this.plane.vy,240)*.7;s?this._drawRotated(s,this.plane.x,this.plane.y,64,64,a):(t.fillStyle="#ff6",t.beginPath(),t.arc(this.plane.x,this.plane.y,this.plane.r,0,F),t.fill()),t.fillStyle="rgba(0,0,0,0.15)",t.fillRect(0,e.height-20,e.width,20),this.state==="menu"?this._drawCenterText("\u041D\u0430\u0436\u043C\u0438\u0442\u0435 \u0441\u0442\u0430\u0440\u0442"):this.state==="paused"?this._drawCenterText("\u041F\u0430\u0443\u0437\u0430"):this.state==="dead"&&this._drawCenterText("\u0421\u0442\u043E\u043B\u043A\u043D\u043E\u0432\u0435\u043D\u0438\u0435"),this.ghosts&&this.ghosts.length>0&&this._drawGhosts()}_drawRotated(t,e,s,a,n,o){let{ctx:l}=this;l.save(),l.translate(e,s),l.rotate(o),l.drawImage(t,-a/2,-n/2,a,n),l.restore()}_drawCenterText(t){let{ctx:e,world:s}=this;e.fillStyle="rgba(0,0,0,0.4)",e.fillRect(0,0,s.width,s.height),e.fillStyle="#fff",e.font="bold 24px system-ui, Arial",e.textAlign="center",e.fillText(t,s.width/2,s.height/2)}_drawGhosts(){let{ctx:t,world:e}=this,s=e.width*.35;t.save(),t.globalAlpha=.6;for(let a of this.ghosts){if(a.overtaken)continue;let n=a.targetDistance-this.distanceMeters,o=Math.max(-s,Math.min(s,n/this.metersPerPixel)),l=this.plane.x+o,u=this.plane.y-80,f=this.planeFrames[this.frameIndex];f&&this._drawRotated(f,l,u,64,64,0),t.fillStyle="white",t.font="12px system-ui, Arial",t.textAlign="center",t.fillText(a.name,l,u-40),n<=0&&(a.overtaken=!0,this.onOvertake?.(a.name))}t.restore(),this.ghosts=this.ghosts.filter(a=>!a.overtaken)}_loop(t){this._lastTs||(this._lastTs=t);let e=Math.min(.033,(t-this._lastTs)/1e3);this._lastTs=t,this._update(e),this._draw(),requestAnimationFrame(this._loop)}};var _=class{constructor(t,e){this.ysdk=t,this.deaths=0,this.interstitialEveryNDeaths=e?.interstitialEveryNDeaths||2,this.bannerInstance=null}trackDeath(){this.deaths+=1}shouldShowInterstitial(){return!this.ysdk||this.interstitialEveryNDeaths<=0?!1:this.deaths>0&&this.deaths%this.interstitialEveryNDeaths===0}async showInterstitial(){if(this.ysdk?.adv?.showInterstitial)return new Promise((t,e)=>{this.ysdk.adv.showInterstitial({callbacks:{onOpen:()=>{this._stopGameplay()},onClose:s=>{this._startGameplay(),t(s)},onOffline:()=>{this._startGameplay(),t(!1)},onError:s=>{this._startGameplay(),e(s)}}})})}async showRewarded(){return this.ysdk?.adv?.showRewardedVideo?new Promise((t,e)=>{this.ysdk.adv.showRewardedVideo({callbacks:{onOpen:()=>{this._stopGameplay()},onRewarded:()=>{},onClose:s=>{this._startGameplay(),s?t(!0):e(new Error("no-reward"))},onError:s=>{this._startGameplay(),e(s)}}})}):Promise.reject(new Error("Rewarded not supported"))}async mountBanner(t){if(!this.ysdk?.adv?.createBannerAdv)return;let e=document.querySelector(t);if(e)try{this.bannerInstance=await this.ysdk.adv.createBannerAdv({containerId:void 0,type:"sticky",rtl:!1}),this.bannerInstance?.render&&await this.bannerInstance.render(e)}catch(s){console.warn("Banner failed",s)}}_stopGameplay(){try{this.ysdk.features.GameplayAPI.stop()}catch{}}_startGameplay(){try{this.ysdk.features.GameplayAPI.start()}catch{}}};var D=class{constructor(t,e){this.ysdk=t,this.boardName=e,this.lb=null,this.ready=this._init()}async _init(){if(!this.ysdk?.getLeaderboards)return null;try{return this.lb=await this.ysdk.getLeaderboards(),this.lb}catch(t){return console.warn("Leaderboards init failed",t),null}}async submitScore(t){if(await this.ready,!!this.lb)try{await this.lb.setLeaderboardScore(this.boardName,t)}catch(e){console.warn("submitScore failed",e)}}async getTop({includeUser:t=!0,quantityTop:e=10}={}){if(await this.ready,!this.lb)return[];try{let s=await this.lb.getLeaderboardEntries(this.boardName,{quantityTop:e,includeUser:t});return s?.entries?.map(a=>({rank:a.rank,name:a.player?.publicName||"\u0418\u0433\u0440\u043E\u043A",score:a.score,me:!!a.player&&a.player.uniqueID===s.userRank?.player?.uniqueID}))||[]}catch(s){return console.warn("getTop failed",s),[]}}async getRandomOpponents(t=3){return(await this.getTop({includeUser:!0,quantityTop:50})).filter(n=>!n.me&&n.score>0).sort(()=>Math.random()-.5).slice(0,t)}};var E=class{constructor(){this.ctx=null,this._muted=!1}isMuted(){return this._muted}setMuted(t){this._muted=!!t}_ensureCtx(){if(!this.ctx){let t=window.AudioContext||window.webkitAudioContext;t&&(this.ctx=new t)}}async beep({frequency:t=440,durationMs:e=100,type:s="sine",volume:a=.05}={}){if(this._muted||(this._ensureCtx(),!this.ctx))return;let n=this.ctx.currentTime,o=this.ctx.createOscillator(),l=this.ctx.createGain();l.gain.value=a,o.type=s,o.frequency.setValueAtTime(t,n),o.connect(l).connect(this.ctx.destination),o.start(),o.stop(n+e/1e3)}flap(){return this.beep({frequency:700,durationMs:60,type:"sine",volume:.06})}score(){return this.beep({frequency:900,durationMs:90,type:"triangle",volume:.07})}hit(){return this.beep({frequency:140,durationMs:150,type:"square",volume:.07})}};var P=class{constructor(t){this.ysdk=t,this.key="flappy-plane"}async _player(){try{return await this.ysdk.getPlayer({signed:!1})}catch{return null}}async getBestScore(){let t=await this._player();if(t&&t.getData)try{return(await t.getData([this.key]))?.[this.key]?.best||0}catch{}try{return JSON.parse(localStorage.getItem(this.key)||"{}").best||0}catch{return 0}}async updateBestScore(t,e){let s=await this.getBestScore(),a=Math.max(s,t);return await this._save({best:a},e),a}async getBestDistance(){try{return JSON.parse(localStorage.getItem(this.key)||"{}").bestDistance||0}catch{return 0}}async updateBestDistance(t){let e=JSON.parse(localStorage.getItem(this.key)||"{}"),s=Math.max(e.bestDistance||0,Math.floor(t));e.bestDistance=s,localStorage.setItem(this.key,JSON.stringify(e));let a=await this._player();if(a&&a.setData)try{await a.setData({[this.key]:e})}catch{}return s}async getSelectedSkin(){return JSON.parse(localStorage.getItem(this.key)||"{}").selectedSkin||"blue"}async setSelectedSkin(t){let e=JSON.parse(localStorage.getItem(this.key)||"{}");e.selectedSkin=t,localStorage.setItem(this.key,JSON.stringify(e));let s=await this._player();if(s&&s.setData)try{await s.setData({[this.key]:e})}catch{}}async getSetting(t){try{return JSON.parse(localStorage.getItem(this.key)||"{}").settings?.[t]}catch{return}}async setSetting(t,e){let s=JSON.parse(localStorage.getItem(this.key)||"{}");s.settings=s.settings||{},s.settings[t]=e,localStorage.setItem(this.key,JSON.stringify(s));let a=await this._player();if(a&&a.setData)try{await a.setData({[this.key]:s})}catch{}}async _save(t,e){let a={...JSON.parse(localStorage.getItem(this.key)||"{}"),...t};localStorage.setItem(this.key,JSON.stringify(a));let n=e||await this._player();if(n&&n.setData)try{await n.setData({[this.key]:a})}catch{}}};var M=class{constructor(t){this.scoreEl=document.querySelector("#hud .score"),this.menu=document.getElementById("menu"),this.settings=document.getElementById("settings"),this.leaderboard=document.getElementById("leaderboard"),this.death=document.getElementById("death"),this.toast=document.getElementById("toast"),this.chkSound=document.getElementById("chk-sound"),this.chkGhosts=document.getElementById("chk-ghosts"),this.selSkin=document.getElementById("sel-skin"),document.getElementById("btn-start").addEventListener("click",t.onStart),document.getElementById("btn-leaderboard").addEventListener("click",t.onOpenLeaderboard),document.getElementById("btn-settings").addEventListener("click",t.onOpenSettings),document.getElementById("btn-back-settings").addEventListener("click",t.onBackFromSettings),document.getElementById("btn-back-lb").addEventListener("click",t.onBackFromLeaderboard),document.getElementById("btn-restart").addEventListener("click",t.onRestart),document.getElementById("btn-rewarded").addEventListener("click",t.onRewarded),document.getElementById("btn-pause").addEventListener("click",t.onPause),document.getElementById("btn-sound").addEventListener("click",()=>{let e=!this.chkSound.checked;this.chkSound.checked=e,t.onToggleSound(e)}),document.getElementById("btn-fullscreen").addEventListener("click",t.onToggleFullscreen),this.chkSound.addEventListener("change",e=>t.onToggleSound(e.target.checked)),this.onToggleGhosts=t.onToggleGhosts||(()=>{}),this.onChangeSkin=t.onChangeSkin||(()=>{}),this.chkGhosts.addEventListener("change",e=>this.onToggleGhosts(e.target.checked)),this.selSkin.addEventListener("change",e=>this.onChangeSkin(e.target.value))}showMenu(t){this._toggle(this.menu,t)}showSettings(t){this._toggle(this.settings,t)}showLeaderboard(t){this._toggle(this.leaderboard,t)}showDeathPanel(t){this._toggle(this.death,t)}showDeath(t,e){this.showDeathPanel(!0),document.getElementById("death-score").textContent=String(t),this.toastMsg(`\u041B\u0443\u0447\u0448\u0438\u0439: ${e}`)}setScore(t){this.scoreEl.textContent=String(t)}renderLeaderboard(t,e){let s=document.getElementById("lb-list");s.innerHTML="";let a=t.map(n=>`<div>#${n.rank} \u2014 ${q(n.name)} \u2014 ${n.score}${n.me?" (\u0432\u044B)":""}</div>`);e&&!t.some(n=>n.me)&&a.unshift(`<div>\u0412\u0430\u0448 \u043B\u043E\u043A\u0430\u043B\u044C\u043D\u044B\u0439 \u0440\u0435\u043A\u043E\u0440\u0434: ${e}</div>`),s.innerHTML=a.join("")}setSoundChecked(t){this.chkSound.checked=!!t}toastMsg(t,e=2e3){this.toast.textContent=t,this.toast.classList.add("visible"),setTimeout(()=>this.toast.classList.remove("visible"),e)}setGhostsChecked(t){this.chkGhosts&&(this.chkGhosts.checked=!!t)}renderSkinOptions(t,e){if(this.selSkin){this.selSkin.innerHTML="";for(let s of t){let a=document.createElement("option");a.value=s.id,a.textContent=s.label+(s.locked?` (\u{1F512} ${s.threshold}\u043C)`:""),a.disabled=!!s.locked,s.id===e&&(a.selected=!0),this.selSkin.appendChild(a)}}}showOvertake(t){this.toastMsg(`\u041E\u0431\u043E\u0433\u043D\u0430\u043D: ${t}`)}_toggle(t,e){t&&(e?t.classList.add("visible"):t.classList.remove("visible"))}};function q(h){return String(h).replace(/[&<>"]+/g,t=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;"})[t])}var J="game",Y="flappy_plane_best",A={blue:["/Planes/planeBlue1.png","/Planes/planeBlue2.png","/Planes/planeBlue3.png"],green:["/Planes/planeGreen1.png","/Planes/planeGreen2.png","/Planes/planeGreen3.png"],red:["/Planes/planeRed1.png","/Planes/planeRed2.png","/Planes/planeRed3.png"],yellow:["/Planes/planeYellow1.png","/Planes/planeYellow2.png","/Planes/planeYellow3.png"]},$=[{id:"blue",label:"\u0421\u0438\u043D\u0438\u0439",threshold:0},{id:"green",label:"\u0417\u0435\u043B\u0451\u043D\u044B\u0439",threshold:500},{id:"red",label:"\u041A\u0440\u0430\u0441\u043D\u044B\u0439",threshold:1e3},{id:"yellow",label:"\u0416\u0451\u043B\u0442\u044B\u0439",threshold:1500}],r=null,p=null,w=null,B=null,S=null,d=null,c=null;(async function(){try{r=await G()}catch(i){console.warn("Yandex SDK failed to init, running in degraded mode",i)}let t=r?R(r):{appId:"local",lang:"ru",tld:"ru",payload:null},e=r?.deviceInfo?.type||"desktop",s={gravity:2200,flapImpulse:620,scrollSpeed:220,pipeGap:180,pipeIntervalMs:1450,interstitialEveryNDeaths:2,showBannerOnMenu:!1,metersPerPixel:.2},a={lang:t.lang,deviceType:e},n=r?await T(r,s,a):s,o=document.getElementById(J);S=new E,d=new P(r),w=new _(r,{interstitialEveryNDeaths:n.interstitialEveryNDeaths}),B=new D(r,Y),c=new M({onStart:H,onPause:U,onResume:z,onRestart:K,onRewarded:V,onOpenSettings:()=>c.showSettings(!0),onBackFromSettings:()=>c.showSettings(!1),onOpenLeaderboard:async()=>{c.showLeaderboard(!0);let i=await B.getTop({includeUser:!0}).catch(()=>[]),g=await d.getBestScore();c.renderLeaderboard(i,g)},onBackFromLeaderboard:()=>c.showLeaderboard(!1),onToggleSound:i=>{S.setMuted(!i),d.setSetting("muted",!i)},onToggleFullscreen:async()=>{if(!r)return;let i=r.screen.fullscreen;i.isSupported()&&(i.isFullscreen()?await i.exit():await i.request())}});let l=r?await L(r):null,u=await d.getSetting("muted");u!==void 0&&S.setMuted(!!u),c.setSoundChecked(!S.isMuted());let f=await d.getBestDistance(),m=await d.getSelectedSkin(),k=O(f);k.some(i=>i.id===m&&!i.locked)||(m=k.filter(i=>!i.locked).slice(-1)[0].id,await d.setSelectedSkin(m)),c.renderSkinOptions(k,m);let b=await d.getSetting("ghosts")!==!1;c.setGhostsChecked(b),p=new I({canvas:o,assets:{bg:"/background.png",rock:"/rock.png",rockDown:"/rockDown.png",planeFrames:A[m]},audio:S,flags:n,skins:A,selectedSkin:m,onScore:i=>c.setScore(i),onDistance:async i=>{},onOvertake:i=>c.showOvertake(i),onDeath:async(i,g)=>{r?.features?.GameplayAPI?.stop();let x=await d.updateBestScore(i,l),y=await d.updateBestDistance(g);await B.submitScore(i).catch(()=>{}),c.showDeath(i,x);let C=O(y);c.renderSkinOptions(C,await d.getSelectedSkin()),w.trackDeath()},onStart:()=>{r?.features?.GameplayAPI?.start(),c.setScore(0),c.showMenu(!1),c.showDeathPanel(!1)},onPause:()=>r?.features?.GameplayAPI?.stop(),onResume:()=>r?.features?.GameplayAPI?.start()});async function v(){if(!b||!r){p.setOpponents([]);return}let i=await B.getRandomOpponents(3).catch(()=>[]),g=n.scrollSpeed*(n.pipeIntervalMs/1e3)*n.metersPerPixel,x=i.map(y=>({name:y.name,targetDistance:y.score*g}));p.setOpponents(x)}v(),r&&n.showBannerOnMenu&&w.mountBanner("#banner-slot").catch(()=>{}),document.addEventListener("visibilitychange",()=>{document.hidden?(p.pause(),r?.features?.GameplayAPI?.stop()):p.isRunning()&&r?.features?.GameplayAPI?.start()}),c.showMenu(!0),N();function O(i){return $.map(g=>({...g,locked:i<g.threshold}))}function N(){c.onToggleGhosts=async i=>{await d.setSetting("ghosts",!!i),v()},c.onChangeSkin=async i=>{if(!O(await d.getBestDistance()).some(y=>y.id===i&&!y.locked)){c.toastMsg("\u0421\u043A\u0438\u043D \u0435\u0449\u0451 \u043D\u0435 \u043E\u0442\u043A\u0440\u044B\u0442");return}await d.setSelectedSkin(i),p.setSkin(i)}}})();async function H(){await j(),await p.start()}async function U(){p.pause()}async function z(){p.resume()}async function K(){w.shouldShowInterstitial()&&await w.showInterstitial().catch(()=>{}),await p.restart()}async function V(){if(!r)return p.restart();try{await w.showRewarded(),await p.continueAfterDeath()}catch{await p.restart()}}async function j(){if(!r)return;let h=await r.getPlayer({signed:!1}).catch(()=>null);(!h||h.getMode&&h.getMode()!=="lite")&&await r.auth.openAuthDialog().catch(()=>{})}})();
